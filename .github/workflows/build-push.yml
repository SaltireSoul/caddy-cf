# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Publish Docker image

on:
  push:
    branches: [ latest ]
  release:
    types:
      -  published
  workflow_dispatch:

jobs:
  build-docker-images:
    name: Build Docker Images
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      
      - name: Login to GitHub Package Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
      - name: Build & Push Docker image
        run: docker buildx build -t ghcr.io/${{ secrets.OWNER_LC }}/caddy-cf:${GITHUB_SHA} -f ./Dockerfile --push --tag=caddy-cf:latest --platform=linux/amd64,linux/arm64,linux/arm/v7 .
      
      - name: Login to Docker Hub
        env:
          DH_TOKEN: ${{ secrets.DOCKER_TOKEN }}
        run: docker login -u ${{ secrets.DOCKER_USER }} -p ${DH_TOKEN}
        
      - name: Re-tag & Push Docker Image to Docker Hub
        run: |
          # make config.json avaiable to regclient in docker container
          chmod +r $HOME/.docker/config.json
          # Run regclient in docker image
          docker container run --rm --net host \
            -v regctl-conf:/home/appuser/.regctl/ \
            -v $HOME/.docker/config.json:/home/appuser/.docker/config.json \
            regclient/regctl:v0.3.9 image copy ghcr.io/${{ secrets.OWNER_LC }}/caddy-cf:${GITHUB_SHA} docker.io/${{ secrets.OWNER_LC }}/caddy-cf:latest
